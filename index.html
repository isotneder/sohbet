<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sohbet Giriş</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="entry-body">
    <main class="entry-container">
      <header class="entry-header">
        <img src="logo.png" alt="Logo" class="entry-logo" />
        <div>
          <h1>Sohbet Girişi</h1>
          <p class="entry-subtitle">
            Kullanıcını seç ve şifrenle giriş yap.
          </p>
        </div>
      </header>

      <form id="entryForm" class="entry-form" autocomplete="off">
        <div class="entry-section">
          <div class="entry-section-title">Kullanıcı seç</div>
          <div class="entry-grid">
            <label class="entry-user" data-user="user1">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user1"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 1"
                  >User 1</span
                >
                <span class="entry-user-meta">Yönetici</span>
              </span>
            </label>
            <div class="entry-divider" aria-hidden="true"></div>
            <label class="entry-user" data-user="user2">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user2"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 2"
                  >User 2</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user3">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user3"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 3"
                  >User 3</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user4">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user4"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 4"
                  >User 4</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user5">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user5"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 5"
                  >User 5</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user6">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user6"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 6"
                  >User 6</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user7">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user7"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 7"
                  >User 7</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user8">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user8"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 8"
                  >User 8</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user9">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user9"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 9"
                  >User 9</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
            <label class="entry-user" data-user="user10">
              <input
                class="entry-radio"
                type="radio"
                name="user"
                value="user10"
                required
              />
              <span class="entry-user-content">
                <span class="entry-user-name" data-default="User 10"
                  >User 10</span
                >
                <span class="entry-user-meta">Kullanıcı</span>
              </span>
            </label>
          </div>
          <div id="entryUserEmpty" class="entry-empty">Onayli kullanici yok.</div>
        </div>

        <div class="entry-field">
          <label class="entry-label" for="passwordInput">Şifre</label>
          <input
            type="password"
            id="passwordInput"
            class="entry-input"
            placeholder="Şifre"
            autocomplete="off"
            required
          />
        </div>

        <button id="loginButton" class="entry-button" type="submit">
          Giriş yap
        </button>
        <div id="loginError" class="entry-error"></div>
      </form>

      <p class="entry-note">
        Hesabiniz yoksa <a class="entry-link" href="create.html">olusturun</a>.
      </p>

      <p class="entry-note">
        Şifreyi unuttuysan User 1 üzerinden ayarlayabilirsin.
      </p>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <script>
      (function () {
        if (!window.firebase) return;

        var firebaseConfig = {
          apiKey: "AIzaSyAG__4nFoAWy368EFicS9N108IkaBAwe2s",
          authDomain: "sohbet-b417a.firebaseapp.com",
          databaseURL:
            "https://sohbet-b417a-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "sohbet-b417a",
        };

        if (!firebase.apps || !firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }

        var db = firebase.database();
        var form = document.getElementById("entryForm");
        var passwordInput = document.getElementById("passwordInput");
        var errorEl = document.getElementById("loginError");
        var userLabels = document.querySelectorAll(".entry-user");
        var dividerEl = document.querySelector(".entry-divider");
        var emptyEl = document.getElementById("entryUserEmpty");
        var displayNamesCache = {};
        var passwordsCache = {};
        var fallbackNames = {
          user1: "User 1",
          user2: "User 2",
          user3: "User 3",
          user4: "User 4",
          user5: "User 5",
          user6: "User 6",
          user7: "User 7",
          user8: "User 8",
          user9: "User 9",
          user10: "User 10",
        };

        function setError(message) {
          if (!errorEl) return;
          errorEl.textContent = message || "";
        }

        function getSelectedUserKey() {
          var checked = document.querySelector('input[name="user"]:checked');
          return checked ? checked.value : "";
        }

        function applyUserList() {
          if (!userLabels || !userLabels.length) return;

          var visibleCount = 0;
          var hasAdmin = false;

          userLabels.forEach(function (label) {
            var key = label.getAttribute("data-user");
            var nameEl = label.querySelector(".entry-user-name");
            if (!key || !nameEl) return;

            var fallback =
              nameEl.getAttribute("data-default") ||
              fallbackNames[key] ||
              key;
            var updated =
              (displayNamesCache && displayNamesCache[key]) || fallback;
            nameEl.textContent = updated;

            var hasPassword = passwordsCache && passwordsCache[key];
            var isVisible = !!hasPassword;
            label.style.display = isVisible ? "" : "none";

            if (isVisible) {
              visibleCount += 1;
              if (key === "user1") {
                hasAdmin = true;
              }
            }
          });

          if (dividerEl) {
            dividerEl.style.display =
              hasAdmin && visibleCount > 1 ? "" : "none";
          }

          if (emptyEl) {
            emptyEl.style.display = visibleCount === 0 ? "block" : "none";
          }

          var selectedKey = getSelectedUserKey();
          if (selectedKey && !(passwordsCache && passwordsCache[selectedKey])) {
            var checked = document.querySelector('input[name="user"]:checked');
            if (checked) checked.checked = false;
          }
        }

        db.ref("displayNames").on("value", function (snapshot) {
          displayNamesCache = snapshot.val() || {};
          applyUserList();
        });

        db.ref("passwords").on("value", function (snapshot) {
          passwordsCache = snapshot.val() || {};
          applyUserList();
        });

        applyUserList();

        if (form) {
          form.addEventListener("input", function () {
            setError("");
          });

          form.addEventListener("submit", function (event) {
            event.preventDefault();

            var userKey = getSelectedUserKey();
            if (!userKey) {
              setError("Kullanıcı seç.");
              return;
            }

            var password = (passwordInput && passwordInput.value.trim()) || "";
            if (!password) {
              setError("Şifre gir.");
              return;
            }

            db.ref("passwords")
              .child(userKey)
              .once("value")
              .then(function (snapshot) {
                var currentPassword = snapshot.val() || "";
                if (!currentPassword) {
                  setError("Bu kullanıcı için şifre ayarlanmamış.");
                  return;
                }

                if (password === currentPassword) {
                  sessionStorage.setItem("chatAuthOk_" + userKey, "true");
                  window.location.href = userKey + ".html";
                } else {
                  setError("Şifre yanlış.");
                }
              })
              .catch(function (err) {
                console.error("login error", err);
                setError("Giriş yapılamadı.");
              });
          });
        }

      })();
    </script>
  </body>
</html>
